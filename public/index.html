<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VoxTalk™ Clone-11</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <header class="topbar">
    <h1 class="brand">VoxTalk<sup>™</sup></h1>
    <nav class="nav-buttons">
      <button class="pill ghost" onclick="openModal('cartModal')">🛒 Cart</button>
      <button class="pill ghost" onclick="openModal('infoModal')">ℹ️ Info</button>
      <button class="pill ghost" onclick="openModal('checkoutModal')">💳 Checkout</button>
    </nav>
  </header>

  <main class="stage">
    <div class="halo-wrapper">
      <button id="haloBtn" class="halo-btn">
        <div class="halo ring r1"></div>
        <div class="halo ring r2"></div>
        <div class="halo ring r3"></div>
        <span class="halo-label">Click&nbsp;to&nbsp;Talk</span>
      </button>
      <button id="stopBtn" class="stop-btn hidden">⏹ Stop Voice</button>
    </div>
    <audio id="remote" autoplay playsinline></audio>
  </main>

  <!-- Classic Chat -->
  <section class="quiet">
    <form id="quietForm" class="quiet-form" autocomplete="off">
      <input id="quietInput" class="quiet-input" type="text"
             placeholder="Type here to chat with VoxTalk..." />
      <button id="sendBtn" class="pill send-btn" type="submit">Send</button>
    </form>
    <div id="thread" class="thread"></div>
  </section>

  <button class="corner-btn left" onclick="window.print()">🖨 Print Conversation</button>
  <a class="corner-btn right" href="tel:18005551234">📞 Contact Human</a>

  <!-- Simple modal logic, voice + chat same as before -->
  <script>
    function openModal(id){ document.getElementById(id).classList.remove("hidden"); }
    function closeModal(id){ document.getElementById(id).classList.add("hidden"); }
    document.querySelectorAll(".modal").forEach(m =>
      m.addEventListener("click", e => { if(e.target===m) m.classList.add("hidden"); })
    );

    // Voice setup
    const haloBtn=document.getElementById("haloBtn");
    const stopBtn=document.getElementById("stopBtn");
    const remote=document.getElementById("remote");
    let pc,localStream;
    haloBtn.onclick=async()=>{
      haloBtn.disabled=true;
      haloBtn.querySelector(".halo-label").textContent="Connecting...";
      const resp=await fetch("/session",{method:"POST"});
      const data=await resp.json();
      if(!data?.client_secret?.value)return;
      pc=new RTCPeerConnection();
      pc.ontrack=e=>remote.srcObject=e.streams[0];
      localStream=await navigator.mediaDevices.getUserMedia({audio:true});
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      const r2=await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",{
        method:"POST",
        headers:{
          Authorization:`Bearer ${data.client_secret.value}`,
          "Content-Type":"application/sdp"
        },
        body:offer.sdp
      });
      const answer={type:"answer",sdp:await r2.text()};
      await pc.setRemoteDescription(answer);
      haloBtn.querySelector(".halo-label").textContent="Live";
      stopBtn.classList.remove("hidden");
    };
    stopBtn.onclick=()=>{
      if(localStream) localStream.getTracks().forEach(t=>t.stop());
      if(pc) pc.close();
      haloBtn.disabled=false;
      haloBtn.querySelector(".halo-label").textContent="Click to Talk";
      stopBtn.classList.add("hidden");
    };

    // Classic Chat
    const form=document.getElementById("quietForm");
    const input=document.getElementById("quietInput");
    const thread=document.getElementById("thread");
    form.onsubmit=async(e)=>{
      e.preventDefault();
      const text=input.value.trim();
      if(!text)return;
      const userDiv=document.createElement("div");
      userDiv.textContent="🧍 "+text;
      thread.appendChild(userDiv);
      input.value="";
      const resp=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:text})});
      const data=await resp.json();
      const botDiv=document.createElement("div");
      botDiv.textContent="🤖 "+(data.reply||"..."); 
      thread.appendChild(botDiv);
      thread.scrollTop=thread.scrollHeight;
    };
  </script>
</body>
</html>
