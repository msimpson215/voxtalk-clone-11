<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VoxTalk‚Ñ¢ Clone-11 (Stripe)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <header class="topbar">
    <h1 class="brand">VoxTalk<sup>‚Ñ¢</sup></h1>
    <nav class="nav-buttons">
      <button class="pill ghost" onclick="openModal('cartModal')">üõí Cart</button>
      <button class="pill ghost" onclick="openModal('infoModal')">‚ÑπÔ∏è Info</button>
      <button class="pill ghost" onclick="openModal('checkoutModal')">üí≥ Checkout</button>
    </nav>
  </header>

  <main class="stage">
    <button id="haloBtn" class="halo-btn">
      <div class="halo ring r1"></div>
      <div class="halo ring r2"></div>
      <div class="halo ring r3"></div>
      <span class="halo-label">Click&nbsp;to&nbsp;Talk</span>
    </button>
    <audio id="remote" autoplay playsinline></audio>
    <button id="stopBtn" class="stop-btn hidden">Stop Voice</button>
  </main>

  <!-- Classic Chat -->
  <section class="quiet">
    <form id="quietForm" class="quiet-form" autocomplete="off">
      <input id="quietInput" class="quiet-input" type="text"
             placeholder="Type here to chat with VoxTalk..." />
      <button id="sendBtn" class="pill send-btn" type="submit">Send</button>
    </form>
    <div id="thread" class="thread"></div>
  </section>

  <button class="corner-btn left" onclick="window.print()">üñ® Print Conversation</button>
  <a class="corner-btn right" href="tel:18005551234">üìû Contact Human</a>

  <!-- CART MODAL -->
  <div id="cartModal" class="modal hidden">
    <div class="modal-content">
      <h2>Your Cart</h2>
      <div class="cart-item">
        <img src="https://dummyimage.com/100x100/4ea8ff/ffffff&text=VoxTalk" alt="Product">
        <div class="cart-details">
          <p class="item-name">VoxTalk Subscription (Demo)</p>
          <p class="item-desc">AI voice + chat assistant for your store or site.</p>
          <p class="item-price">$50.00</p>
        </div>
      </div>
      <hr>
      <p class="subtotal">Subtotal: <strong>$50.00</strong></p>
      <button class="pill" onclick="closeModal('cartModal')">Close</button>
    </div>
  </div>

  <!-- INFO MODAL -->
  <div id="infoModal" class="modal hidden">
    <div class="modal-content">
      <h2>About VoxTalk</h2>
      <p><strong>Talk or type ‚Äî your calm AI partner for any website.</strong></p>
      <p>VoxTalk brings real-time voice conversation and instant answers to any business website, store, or customer portal. It remembers context, provides help, and connects to checkout.</p>
      <p>Use the <em>Click to Talk</em> button to start voice chat, or type below for text conversation.</p>
      <p class="note">Powered by OpenAI and Stripe (Test Mode). Click outside this box to return.</p>
      <button class="pill" onclick="closeModal('infoModal')">Close</button>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutModal" class="modal hidden">
    <div class="modal-content">
      <h2>Secure Checkout</h2>
      <p>You‚Äôll be redirected to a secure Stripe checkout page (Test Mode).</p>
      <button id="checkoutBtn" class="pill">Proceed to Payment</button>
      <button class="pill ghost" onclick="closeModal('checkoutModal')">Cancel</button>
    </div>
  </div>

  <script>
  // Modal logic
  function openModal(id){ document.getElementById(id).classList.remove("hidden"); }
  function closeModal(id){ document.getElementById(id).classList.add("hidden"); }
  document.querySelectorAll(".modal").forEach(m =>
    m.addEventListener("click", e => { if(e.target===m) m.classList.add("hidden"); })
  );

  // Voice
  const haloBtn=document.getElementById("haloBtn");
  const stopBtn=document.getElementById("stopBtn");
  const remote=document.getElementById("remote");
  let pc,localStream;
  haloBtn.onclick=async()=>{
    haloBtn.disabled=true;
    haloBtn.querySelector(".halo-label").textContent="Connecting...";
    const resp=await fetch("/session",{method:"POST"});
    const data=await resp.json();
    if(!data?.client_secret?.value)return;
    pc=new RTCPeerConnection();
    pc.ontrack=e=>remote.srcObject=e.streams[0];
    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    const r2=await fetch("https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview",{
      method:"POST",
      headers:{
        Authorization:`Bearer ${data.client_secret.value}`,
        "Content-Type":"application/sdp"
      },
      body:offer.sdp
    });
    const answer={type:"answer",sdp:await r2.text()};
    await pc.setRemoteDescription(answer);
    haloBtn.querySelector(".halo-label").textContent="Live";
    stopBtn.classList.remove("hidden");
  };
  stopBtn.onclick=()=>{
    if(localStream) localStream.getTracks().forEach(t=>t.stop());
    if(pc) pc.close();
    haloBtn.disabled=false;
    haloBtn.querySelector(".halo-label").textContent="Click to Talk";
    stopBtn.classList.add("hidden");
  };

  // Classic Chat
  const form=document.getElementById("quietForm");
  const input=document.getElementById("quietInput");
  const thread=document.getElementById("thread");
  form.onsubmit=async(e)=>{
    e.preventDefault();
    const text=input.value.trim();
    if(!text)return;
    const userDiv=document.createElement("div");
    userDiv.textContent="üßç "+text;
    thread.appendChild(userDiv);
    input.value="";
    const resp=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:text})});
    const data=await resp.json();
    const botDiv=document.createElement("div");
    botDiv.textContent="ü§ñ "+(data.reply||"..."); thread.appendChild(botDiv);
    thread.scrollTop=thread.scrollHeight;
  };

  // Stripe Checkout
  const stripe = Stripe("pk_test_51SHCGpE44DdqctQ41sbQyxJ2Sjx4yh6SXV01ZSB34foIWPvl8OKCkfkYw9017PhK2tp0euZTaLjxvI1FOQ4uA8hm00ELjyCDK5");
  document.getElementById("checkoutBtn").addEventListener("click", async () => {
    const resp = await fetch("/create-checkout-session", { method: "POST" });
    const data = await resp.json();
    window.location.href = data.url;
  });
  </script>
</body>
</html>
